const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');
const path = require('path');
require('dotenv').config({ path: '.env.local' });

const supabaseUrl = process.env.EXPO_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  console.error('‚ùå Variables de entorno de Supabase no encontradas');
  console.error('Verifica que EXPO_PUBLIC_SUPABASE_URL y EXPO_PUBLIC_SUPABASE_ANON_KEY est√©n configuradas');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseAnonKey);

/**
 * Script para subir thumbnails de videos a Supabase Storage y actualizar la base de datos
 * 
 * Uso:
 * node scripts/uploadThumbnail.js <ruta-imagen> <video-tier> <video-filename>
 * 
 * Ejemplos:
 * node scripts/uploadThumbnail.js ./images/thumbnail.png free abductor-elevacion-cadera
 * node scripts/uploadThumbnail.js ./images/premium-thumb.jpg premium skipping-alterno-elevacion-cadera
 */

/**
 * Sube un thumbnail y actualiza autom√°ticamente la base de datos
 */
async function uploadThumbnail(imagePath, tier = 'free', videoFilename) {
  try {
    console.log('üñºÔ∏è  Iniciando subida de thumbnail a Supabase Storage...\n');

    // Verificar que el archivo existe
    if (!fs.existsSync(imagePath)) {
      throw new Error(`El archivo ${imagePath} no existe`);
    }

    // Verificar que es un archivo de imagen
    const allowedExtensions = ['.png', '.jpg', '.jpeg', '.webp'];
    const fileExtension = path.extname(imagePath).toLowerCase();
    
    if (!allowedExtensions.includes(fileExtension)) {
      throw new Error(`Extensi√≥n de archivo no permitida: ${fileExtension}. Permitidas: ${allowedExtensions.join(', ')}`);
    }

    // Validar tier
    if (!['free', 'premium'].includes(tier)) {
      throw new Error(`Tier no v√°lido: ${tier}. Debe ser 'free' o 'premium'`);
    }

    // Obtener informaci√≥n del archivo
    const stats = fs.statSync(imagePath);
    const fileSizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
    
    console.log(`üìÅ Archivo: ${path.basename(imagePath)}`);
    console.log(`üìè Tama√±o: ${fileSizeInMB} MB`);
    console.log(`üè∑Ô∏è  Categor√≠a: ${tier}`);
    console.log(`üé¨ Video: ${videoFilename}`);

    // Verificar l√≠mite de tama√±o (10MB para im√°genes)
    if (stats.size > 10 * 1024 * 1024) {
      throw new Error(`El archivo es demasiado grande (${fileSizeInMB} MB). M√°ximo permitido: 10 MB`);
    }

    // Generar nombre del thumbnail
    const thumbnailName = `${videoFilename}-thumb${fileExtension}`;
    const storagePath = `${tier}/thumbnails/${thumbnailName}`;

    console.log(`üì§ Subiendo a: videos/${storagePath}`);

    // Leer el archivo
    const fileBuffer = fs.readFileSync(imagePath);

    // Verificar que el video existe en la base de datos
    console.log('üîç Verificando que el video existe en la base de datos...');
    const videoPath = `${tier}/${videoFilename}.mp4`;
    const { data: videoData, error: videoError } = await supabase
      .from('videos')
      .select('id, title, video_url')
      .eq('video_url', videoPath)
      .single();

    if (videoError || !videoData) {
      throw new Error(`No se encontr√≥ un video con la ruta: ${videoPath}. Aseg√∫rate de que el video existe en la base de datos.`);
    }

    console.log(`‚úÖ Video encontrado: "${videoData.title}" (ID: ${videoData.id})`);

    // Subir al storage
    console.log('üì§ Subiendo thumbnail al Storage...');
    const { data, error } = await supabase.storage
      .from('videos')
      .upload(storagePath, fileBuffer, {
        contentType: `image/${fileExtension.slice(1) === 'jpg' ? 'jpeg' : fileExtension.slice(1)}`,
        cacheControl: '3600',
        upsert: true // Permitir sobrescribir si ya existe
      });

    if (error) {
      throw error;
    }

    console.log('‚úÖ Thumbnail subido exitosamente!');
    console.log(`üìç Ruta en Storage: ${data.path}`);

    // Actualizar la base de datos con la URL del thumbnail
    console.log('üíæ Actualizando base de datos...');
    const { error: updateError } = await supabase
      .from('videos')
      .update({
        thumbnail_url: storagePath,
        updated_at: new Date().toISOString()
      })
      .eq('id', videoData.id);

    if (updateError) {
      throw updateError;
    }

    console.log('‚úÖ Base de datos actualizada exitosamente!');

    // Generar URL p√∫blica (temporal para verificaci√≥n)
    const { data: urlData } = await supabase.storage
      .from('videos')
      .createSignedUrl(storagePath, 300); // 5 minutos

    if (urlData) {
      console.log(`üîó URL temporal (5 min): ${urlData.signedUrl}`);
    }

    console.log('\nüéâ ¬°Proceso completado exitosamente!');
    console.log('\nüìã Resumen:');
    console.log(`‚Ä¢ Thumbnail subido: ${storagePath}`);
    console.log(`‚Ä¢ Video actualizado: ${videoData.title}`);
    console.log(`‚Ä¢ Campo thumbnail_url actualizado en la base de datos`);

    return {
      path: storagePath,
      size: stats.size,
      fileName: thumbnailName,
      tier: tier,
      videoId: videoData.id,
      videoTitle: videoData.title
    };

  } catch (error) {
    console.error('‚ùå Error subiendo thumbnail:', error.message);
    process.exit(1);
  }
}

/**
 * Lista todos los thumbnails existentes
 */
async function listThumbnails() {
  try {
    console.log('üìã Thumbnails en Supabase Storage:\n');

    const { data: freeThumbnails, error: freeError } = await supabase.storage
      .from('videos')
      .list('free/thumbnails');

    const { data: premiumThumbnails, error: premiumError } = await supabase.storage
      .from('videos')
      .list('premium/thumbnails');

    if (freeError && freeError.message !== 'The resource was not found') {
      throw freeError;
    }

    if (premiumError && premiumError.message !== 'The resource was not found') {
      throw premiumError;
    }

    console.log('üÜì Thumbnails gratuitos:');
    if (freeThumbnails && freeThumbnails.length > 0) {
      freeThumbnails.forEach(thumbnail => {
        if (thumbnail.name !== '.placeholder') {
          const sizeInKB = (thumbnail.metadata?.size / 1024).toFixed(1);
          console.log(`   - ${thumbnail.name} (${sizeInKB} KB)`);
        }
      });
    } else {
      console.log('   (sin thumbnails)');
    }

    console.log('\nüíé Thumbnails premium:');
    if (premiumThumbnails && premiumThumbnails.length > 0) {
      premiumThumbnails.forEach(thumbnail => {
        if (thumbnail.name !== '.placeholder') {
          const sizeInKB = (thumbnail.metadata?.size / 1024).toFixed(1);
          console.log(`   - ${thumbnail.name} (${sizeInKB} KB)`);
        }
      });
    } else {
      console.log('   (sin thumbnails)');
    }

    // Mostrar tambi√©n videos sin thumbnails
    console.log('\nüîç Verificando videos sin thumbnails...');
    const { data: videosWithoutThumbnails, error: videosError } = await supabase
      .from('videos')
      .select('id, title, video_url, is_premium')
      .is('thumbnail_url', null);

    if (videosError) {
      console.error('Error obteniendo videos sin thumbnails:', videosError);
    } else if (videosWithoutThumbnails && videosWithoutThumbnails.length > 0) {
      console.log('\n‚ö†Ô∏è  Videos sin thumbnails:');
      videosWithoutThumbnails.forEach(video => {
        const tier = video.is_premium ? 'premium' : 'free';
        const videoFilename = path.basename(video.video_url, '.mp4');
        console.log(`   - ${video.title} (${tier}/${videoFilename})`);
      });
    } else {
      console.log('\n‚úÖ Todos los videos tienen thumbnails asignados');
    }

  } catch (error) {
    console.error('‚ùå Error listando thumbnails:', error.message);
  }
}

/**
 * Elimina un thumbnail del storage y actualiza la base de datos
 */
async function deleteThumbnail(thumbnailPath) {
  try {
    console.log(`üóëÔ∏è  Eliminando thumbnail: ${thumbnailPath}`);

    // Buscar el video que usa este thumbnail
    const { data: videoData, error: videoError } = await supabase
      .from('videos')
      .select('id, title')
      .eq('thumbnail_url', thumbnailPath)
      .single();

    if (videoError && videoError.code !== 'PGRST116') {
      throw videoError;
    }

    // Eliminar del storage
    const { error: storageError } = await supabase.storage
      .from('videos')
      .remove([thumbnailPath]);

    if (storageError) {
      throw storageError;
    }

    console.log('‚úÖ Thumbnail eliminado del storage');

    // Actualizar la base de datos si hab√≠a un video usando este thumbnail
    if (videoData) {
      const { error: updateError } = await supabase
        .from('videos')
        .update({
          thumbnail_url: null,
          updated_at: new Date().toISOString()
        })
        .eq('id', videoData.id);

      if (updateError) {
        throw updateError;
      }

      console.log(`‚úÖ Video "${videoData.title}" actualizado (thumbnail_url = null)`);
    }

    console.log('‚úÖ Proceso completado exitosamente');

  } catch (error) {
    console.error('‚ùå Error eliminando thumbnail:', error.message);
  }
}

/**
 * Actualiza manualmente el thumbnail_url de un video
 */
async function updateVideoThumbnail(videoId, thumbnailPath) {
  try {
    console.log(`üîÑ Actualizando thumbnail del video ${videoId}...`);

    // Verificar que el video existe
    const { data: videoData, error: videoError } = await supabase
      .from('videos')
      .select('id, title, video_url')
      .eq('id', videoId)
      .single();

    if (videoError || !videoData) {
      throw new Error(`No se encontr√≥ un video con ID: ${videoId}`);
    }

    // Verificar que el thumbnail existe en el storage si se proporciona una ruta
    if (thumbnailPath) {
      const { data: fileData, error: fileError } = await supabase.storage
        .from('videos')
        .list(path.dirname(thumbnailPath), {
          search: path.basename(thumbnailPath)
        });

      if (fileError || !fileData || fileData.length === 0) {
        throw new Error(`No se encontr√≥ el thumbnail en el storage: ${thumbnailPath}`);
      }
    }

    // Actualizar la base de datos
    const { error: updateError } = await supabase
      .from('videos')
      .update({
        thumbnail_url: thumbnailPath,
        updated_at: new Date().toISOString()
      })
      .eq('id', videoId);

    if (updateError) {
      throw updateError;
    }

    console.log(`‚úÖ Video "${videoData.title}" actualizado`);
    console.log(`üìç Nuevo thumbnail: ${thumbnailPath || 'null'}`);

  } catch (error) {
    console.error('‚ùå Error actualizando thumbnail del video:', error.message);
  }
}

// Procesar argumentos de l√≠nea de comandos
async function main() {
  const args = process.argv.slice(2);

  if (args.length === 0) {
    console.log('üìñ Uso del script de thumbnails:\n');
    console.log('üì§ Subir thumbnail:');
    console.log('   node scripts/uploadThumbnail.js <ruta-imagen> <video-tier> <video-filename>');
    console.log('   Ejemplo: node scripts/uploadThumbnail.js ./thumb.png free abductor-elevacion-cadera\n');
    console.log('üìã Listar thumbnails:');
    console.log('   node scripts/uploadThumbnail.js --list\n');
    console.log('üóëÔ∏è  Eliminar thumbnail:');
    console.log('   node scripts/uploadThumbnail.js --delete <ruta-en-storage>');
    console.log('   Ejemplo: node scripts/uploadThumbnail.js --delete free/thumbnails/video-thumb.png\n');
    console.log('üîÑ Actualizar thumbnail de video:');
    console.log('   node scripts/uploadThumbnail.js --update <video-id> <thumbnail-path>');
    console.log('   Ejemplo: node scripts/uploadThumbnail.js --update abc123 free/thumbnails/nuevo-thumb.png\n');
    console.log('üìã Estructura de carpetas objetivo:');
    console.log('   videos/');
    console.log('   ‚îú‚îÄ‚îÄ free/');
    console.log('   ‚îÇ   ‚îú‚îÄ‚îÄ video.mp4');
    console.log('   ‚îÇ   ‚îî‚îÄ‚îÄ thumbnails/');
    console.log('   ‚îÇ       ‚îî‚îÄ‚îÄ video-thumb.png');
    console.log('   ‚îî‚îÄ‚îÄ premium/');
    console.log('       ‚îú‚îÄ‚îÄ video.mp4');
    console.log('       ‚îî‚îÄ‚îÄ thumbnails/');
    console.log('           ‚îî‚îÄ‚îÄ video-thumb.png');
    return;
  }

  const command = args[0];

  if (command === '--list') {
    await listThumbnails();
  } else if (command === '--delete') {
    if (!args[1]) {
      console.error('‚ùå Especifica la ruta del thumbnail a eliminar');
      return;
    }
    await deleteThumbnail(args[1]);
  } else if (command === '--update') {
    if (!args[1] || !args[2]) {
      console.error('‚ùå Especifica el ID del video y la ruta del thumbnail');
      return;
    }
    await updateVideoThumbnail(args[1], args[2]);
  } else {
    // Subir thumbnail
    const imagePath = args[0];
    const tier = args[1];
    const videoFilename = args[2];

    if (!imagePath || !tier || !videoFilename) {
      console.error('‚ùå Faltan par√°metros requeridos');
      console.error('Uso: node scripts/uploadThumbnail.js <ruta-imagen> <video-tier> <video-filename>');
      return;
    }

    if (!['free', 'premium'].includes(tier)) {
      console.error('‚ùå El tier debe ser "free" o "premium"');
      return;
    }

    await uploadThumbnail(imagePath, tier, videoFilename);
  }
}

main().catch(console.error);